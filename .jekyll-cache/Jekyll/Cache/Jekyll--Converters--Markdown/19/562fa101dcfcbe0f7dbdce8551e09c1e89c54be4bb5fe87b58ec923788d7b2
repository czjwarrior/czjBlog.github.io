I"Ÿ<p>ç°åœ¨å¥½å¤šåº”æœ‰éƒ½å…·å¤‡æ‰«ç åŠŸèƒ½ï¼Œä¸ºäº†å‡å°‘ç”¨æˆ·æ“ä½œï¼Œä¸€èˆ¬ä¼šåœ¨å…‰çº¿æ¯”è¾ƒæš—çš„æ—¶å€™ï¼Œè‡ªåŠ¨æ‰“å¼€é—ªå…‰ç¯ï¼š</p>

<p>1ã€å¯¼å…¥å¤´æ–‡ä»¶</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#import &lt;AVFoundation/AVFoundation.h&gt;
#import &lt;ImageIO/ImageIO.h&gt;
</code></pre></div></div>

<p>2ã€åˆ›å»ºè®¾å¤‡ã€è¾“å…¥è¾“å‡ºæµ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// 1.è·å–ç¡¬ä»¶è®¾å¤‡
    AVCaptureDevice *device = [AVCaptureDevice defaultDeviceWithMediaType:AVMediaTypeVideo];

    // 2.åˆ›å»ºè¾“å…¥æµ
    AVCaptureDeviceInput *input = [[AVCaptureDeviceInput alloc]initWithDevice:device error:nil];

    // 3.åˆ›å»ºè®¾å¤‡è¾“å‡ºæµ
    AVCaptureVideoDataOutput *output = [[AVCaptureVideoDataOutput alloc] init];
    [output setSampleBufferDelegate:self queue:dispatch_get_main_queue()];


    // AVCaptureSessionå±æ€§
    self.session = [[AVCaptureSession alloc]init];
    // è®¾ç½®ä¸ºé«˜è´¨é‡é‡‡é›†ç‡
    [self.session setSessionPreset:AVCaptureSessionPresetHigh];
    // æ·»åŠ ä¼šè¯è¾“å…¥å’Œè¾“å‡º
    if ([self.session canAddInput:input]) {
        [self.session addInput:input];
    }
    if ([self.session canAddOutput:output]) {
        [self.session addOutput:output];
    }

    // 9.å¯åŠ¨ä¼šè¯
    [self.session startRunning];
</code></pre></div></div>

<p>3ã€å®ç°ä»£ç†æ–¹æ³•</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#pragma mark - AVCaptureVideoDataOutputSampleBufferDelegate

- (void)captureOutput:(AVCaptureOutput *)captureOutput didOutputSampleBuffer:(CMSampleBufferRef)sampleBuffer fromConnection:(AVCaptureConnection *)connection{
    CFDictionaryRef metadataDict = CMCopyDictionaryOfAttachments(NULL,sampleBuffer, kCMAttachmentMode_ShouldPropagate);
    NSDictionary *metadata = [[NSMutableDictionary alloc] initWithDictionary:(__bridge NSDictionary*)metadataDict];
    CFRelease(metadataDict);
    NSDictionary *exifMetadata = [[metadata objectForKey:(NSString *)kCGImagePropertyExifDictionary] mutableCopy];
    float brightnessValue = [[exifMetadata objectForKey:(NSString *)kCGImagePropertyExifBrightnessValue] floatValue];
    // brightnessValue å€¼ä»£è¡¨å…‰çº¿å¼ºåº¦ï¼Œå€¼è¶Šå°ä»£è¡¨å…‰çº¿è¶Šæš—
    if (brightnessValue &lt;= -2 &amp;&amp; !_isAutoOpen) {
        _isAutoOpen = YES;
        [self.torchBtn setSelected:YES];
        [self turnTorchOn:YES];
    }
}
</code></pre></div></div>

<p>4ã€å¼€å¯å…³é—­é—ªå…‰ç¯</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// æ‰“å¼€/å…³é—­æ‰‹ç”µç­’
- (void)turnTorchOn:(BOOL)on{
    if ([self.device hasTorch] &amp;&amp; [self.device hasFlash]){

        [self.device lockForConfiguration:nil];
        if (on) {
            [self.device setTorchMode:AVCaptureTorchModeOn];
            [self.device setFlashMode:AVCaptureFlashModeOn];
        } else {
            [self.device setTorchMode:AVCaptureTorchModeOff];
            [self.device setFlashMode:AVCaptureFlashModeOff];
        }
        [self.device unlockForConfiguration];
    } else {
        [SSAlertView showWithTitle:@"æç¤º" message:@"å½“å‰è®¾å¤‡æ²¡æœ‰é—ªå…‰ç¯ï¼Œä¸èƒ½æä¾›æ‰‹ç”µç­’åŠŸèƒ½" commitTitle:@"æˆ‘çŸ¥é“äº†" cancelTitle:nil commitAction:nil cancelBlock:nil];
    }
}
</code></pre></div></div>

<h2 id="å¤§åŠŸå‘Šæˆ">å¤§åŠŸå‘Šæˆï¼ï¼ï¼</h2>

:ET